---
apiVersion: v1
kind: Template
labels:
  app: wordpress-mysql-persistent
  template: wordpress-mysql-persistent
message: |-
  The following service(s) have been created in your project: ${NAME}, ${DATABASE_SERVICE_NAME}.

  For more information about using this template, including OpenShift considerations, see https://github.com/sclorg/wordpress-ex/blob/master/README.md.
metadata:
  annotations:
    description: An example WordPress application with a MySQL database. For more information
      about using this template, including OpenShift considerations, see https://github.com/sclorg/wordpress-ex/blob/master/README.md.
    iconClass: icon-php
    openshift.io/display-name: WordPress + MySQL
    openshift.io/documentation-url: https://github.com/wordpress/wordpress
    openshift.io/long-description: This template defines resources needed to develop
      a WordPress application, including a build configuration, application deployment
      configuration, and database deployment configuration.
    openshift.io/provider-display-name: Red Hat, Inc.
    openshift.io/support-url: https://access.redhat.com
    tags: quickstart,php,wordpress
    template.openshift.io/bindable: 'false'
  name: wordpress-mysql-persistent
  namespace: openshift
objects:
- apiVersion: v1
  data:
    www.conf: |
                {
                    "settings": {
                        "http": {
                            "header_read_timeout": 600,
                            "body_read_timeout": 600,
                            "send_timeout": 600,
                            "idle_timeout": 900,
                            "max_body_size": 62914560
                        }
                    },                  
                    "listeners": {
                        "*:8090": {
                            "application": "script_index_php"
                        },
                        "*:8091": {
                            "application": "direct_php"
                        },
                        "*:8092": {
                            "application": "adminer"
                        }                        
                    },

                    "applications": {
                        "script_index_php": {
                            "type": "php",
                            "limits": {
                                "timeout": 60,
                                "requests": 10000
                            },                            
                            "processes": {
                                "max": 20,
                                "spare": 5
                            },
                            "root": "/opt/app-root/src/${APPLICATION_DOMAIN}/public_html",
                            "script": "index.php",
                            "options": {
                                "file": "/opt/app-root/etc/php/php.ini",
                                "admin": {
                                    "memory_limit": "192M",
                                    "open_basedir": "/opt/app-root/src/${APPLICATION_DOMAIN}:/opt/app-root/var/lib:/usr/share/php:/usr/local/lib:/usr/lib/php7:/usr/lib/php:/tmp/${APPLICATION_DOMAIN}:/run/php",
                                    "session.save_path" : "/tmp/${APPLICATION_DOMAIN}",
                                    "variables_order": "EGPCS",
                                    "expose_php": "0"
                                },
                                "user": {
                                    "display_errors": "0",
                                    "upload_max_filesize" : "32M",
                                    "post_max_size" : "32M",
                                    "max_execution_time" : "60",
                                    "max_input_time" : "60",
     
                                }
                            }                            
                        },
                        "direct_php": {
                            "type": "php",
                            "processes": {
                                "max": 5,
                                "spare": 1
                            },
                            "limits": {
                                "timeout": 10,
                                "requests": 10000
                            },                              
                            "root": "/opt/app-root/src/${APPLICATION_DOMAIN}/public_html",
                            "index": "index.php",
                            "options": {
                                "file": "/opt/app-root/etc/php/php.ini",
                                "admin": {
                                    "memory_limit": "256M",
                                    "open_basedir": "/opt/app-root/src/${APPLICATION_DOMAIN}:/opt/app-root/var/lib:/usr/share/php:/usr/local/lib:/usr/lib/php7:/usr/lib/php:/tmp/${APPLICATION_DOMAIN}:/run/php",
                                    "session.save_path" : "/tmp/${APPLICATION_DOMAIN}",
                                    "variables_order": "EGPCS",
                                    "expose_php": "0"
                                },
                                "user": {
                                    "display_errors": "0",
                                    "upload_max_filesize" : "32M",
                                    "post_max_size" : "32M",
                                    "max_execution_time" : "600",
                                    "max_input_time" : "600"
                            
                                }
                            }                              
                        },
                        "adminer": {
                            "type": "php",
                            "processes": {
                                "max": 5,
                                "spare": 1,
                                "idle_timeout": 15,
                            },
                            "limits": {
                                "timeout": 600,
                                "requests": 10000
                            },
                            "environment": {
                                "server": "nginx/0.1"
                            },
                            "working_directory": "/usr/local/lib/php",                             
                            "root": "/usr/local/lib/php",
                            "index": "adminer.php",
                            "options": {
                                "file": "/opt/app-root/etc/php/php.ini",
                                "admin": {
                                    "memory_limit": "256M",
                                    "open_basedir": "/opt/app-root/src/${APPLICATION_DOMAIN}:/opt/app-root/var/lib:/usr/share/php:/usr/local/lib:/usr/lib/php7:/usr/lib/php:/tmp/${APPLICATION_DOMAIN}:/run/php",
                                    "session.save_path" : "/tmp/${APPLICATION_DOMAIN}",
                                    "variables_order": "EGPCS",
                                    "expose_php": "0"
                                },
                                "user": {
                                    "display_errors": "0",
                                    "upload_max_filesize" : "32M",
                                    "post_max_size" : "32M",
                                    "max_execution_time" : "600",
                                    "max_input_time" : "600",
                                    
                                }
                            }                              
                        }                        
                    }
                }          
  kind: ConfigMap
  metadata:
    name: "${NAME}-php"
- apiVersion: v1
  data:
    www.conf: |
                    include /etc/nginx/cache_params;
                    include /etc/nginx/gzip_params;

                    # Only on server block
                    #client_header_buffer_size    1k;
                    # Only on server block
                    #large_client_header_buffers  4 8k;

                    # If the client stops reading data, free up the stale client connection after this much time. Default 60.
                    #send_timeout 6;
                    # Only on server block
                    #client_header_timeout  3m;

                    #include naxsi/naxsi_core.rules;

                    # Location order
                    # = (exactly) : location = /path
                    # ^~ (forward match) : location ^~ /path
                    # ~ (regular expression case sensitive) : location ~ /path/
                    # ~* (regular expression case insensitive) : location ~* .(jpg|png|bmp)
                    # / : location /path

                    # If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the
                    # scheme used to connect to this server
                    map $http_x_forwarded_proto $proxy_x_forwarded_proto {
                     default $http_x_forwarded_proto;
                     ''      $scheme;
                    }

                    # If we receive Upgrade, set Connection to "upgrade"; otherwise, delete any
                    # Connection header that may have been passed to this server
                    map $http_upgrade $proxy_connection {
                     default upgrade;
                     '' close;
                    }
                    upstream unit_wp_index {
                        server 127.0.0.1:8090;
                    }

                    upstream unit_wp_direct {
                        server 127.0.0.1:8091;
                    }
                    upstream unit_adminer {
                        server 127.0.0.1:8092;
                    }

                    server {

                      listen 8081;
                      server_name _;                    
                      include /etc/nginx/rewrite_server;
                      location = /adminer.php {
                        proxy_pass http://unit_adminer;
                                proxy_set_header Host $http_x_forwarded_host:$http_x_forwarded_port;
                                proxy_set_header PORT $http_x_forwarded_port;  
                                proxy_set_header X-Real-IP $http_x_forwarded_host;
                                proxy_set_header X-Real-SCHEME $http_x_forwarded_proto;
                                proxy_set_header X-Real-HTTPS $fe_https; 
                                # send the client a "request timed out" if the body is not loaded by this time. Default 60.
                                client_body_timeout 10m;
                                client_max_body_size 64M;
                                client_body_buffer_size     4M;

                                # Permit bigger uploads
                                proxy_buffering off;
                                proxy_buffer_size 32k;
                                proxy_buffers 4 32k;
                                proxy_busy_buffers_size 64k;
                                proxy_read_timeout 600; 
                                proxy_send_timeout 600;
                                proxy_connect_timeout 600;                                                     
                      }
                    }

                    limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
                    server {
                        listen 8080 default_server;
                        server_name _;

                        #access_log off;

                        include error_page_params;
                        include server_cache_params;

                        # this prevents hidden files (beginning with a period) from being served
                        location ~ /\.          { access_log off; log_not_found off; deny all; }

                        location = /xmlrpc.php { return 404; }

                            root /opt/app-root/src/${APPLICATION_DOMAIN}/public_html;
                            #index index.html index.htm index.php;

                            location / {
                                try_files index.html index.htm $uri @index_php;
                            }


                            location ~* .(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|css|rss|atom|js|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
                                    expires max;
                                    log_not_found off;
                                    access_log off;
                                    aio threads=default;
                            }
                            location = /robots.txt {
                                    access_log off;
                                    log_not_found off;
                            }
                            location = /favicon.ico {
                              expires max;
                              log_not_found off;
                              access_log off;
                            }

                            location ~* /wp-content/uploads/\.(hh|php)$ {
                                return 404;
                            }
                            location /wp-admin {
                                limit_req zone=one burst=4 nodelay;
                                index index.php;
                            }
                            location /wp-login.php {
                                limit_req zone=one burst=4 nodelay;                        
                            }                            
                            location @index_php {
                                access_log off;
                                fastcgi_ignore_headers Vary Set-Cookie Cache-Control Expires X-Accel-Expires;  
                                include proxy_cache_params;
                                proxy_pass       http://unit_wp_index;
                                proxy_set_header Host $http_x_forwarded_host:$http_x_forwarded_port;
                                proxy_set_header PORT $http_x_forwarded_port;  
                                proxy_set_header X-Real-IP $http_x_forwarded_host;
                                proxy_set_header X-Real-SCHEME $http_x_forwarded_proto;
                                proxy_set_header X-Real-HTTPS $fe_https;                                    
                            }
                            location ~* \.(hh|php)$ {
                                try_files $uri =404;

                                ## Naxsi rules
                                #include fastcgi_naxsi_params

                                #Bypass cache
                                #{{NGINX_CACHE}}

                                #include proxy_cache_params;
                                proxy_pass http://unit_wp_direct;
                                proxy_set_header Host $http_x_forwarded_host:$http_x_forwarded_port;
                                proxy_set_header PORT $http_x_forwarded_port;  
                                proxy_set_header X-Real-IP $http_x_forwarded_host;
                                proxy_set_header X-Real-SCHEME $http_x_forwarded_proto;
                                proxy_set_header X-Real-HTTPS $fe_https;    
                                # send the client a "request timed out" if the body is not loaded by this time. Default 60.
                                client_body_timeout 10m;
                                client_max_body_size 64M;
                                client_body_buffer_size     4M;

                                # Permit bigger uploads
                                proxy_buffering off;
                                proxy_buffer_size 32k;
                                proxy_buffers 4 32k;
                                proxy_busy_buffers_size 64k;
                                proxy_read_timeout 600; 
                                proxy_send_timeout 600;
                                proxy_connect_timeout 600;                                    

                            }

                    }

                    # server {
                    #     listen       8080 default_server;
                    #     server_name  _;
                    #     return       301 http://{{DOMAIN_PROD}};
                    # }
  kind: ConfigMap
  metadata:
    name: ${NAME}-nginx
- apiVersion: v1
  kind: Secret
  metadata:
    name: "${NAME}"
  stringData:
    wordpress-secret-token: "${WP_SECRET_TOKEN}"
    wordpress-security-salt: "${WP_SECURITY_SALT}"
    database-password: "${DATABASE_PASSWORD}"
    database-user: "${DATABASE_USER}"
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      description: Exposes and load balances the application pods
      service.alpha.openshift.io/dependencies: '[{"name": "${DATABASE_SERVICE_NAME}",
        "kind": "Service"}]'
    name: "${NAME}"
  spec:
    ports:
    - name: web
      port: 8080
      targetPort: 8080
    selector:
      name: "${NAME}"
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      description: Exposes and load balances the application pods
      service.alpha.openshift.io/dependencies: '[{"name": "${DATABASE_SERVICE_NAME}",
        "kind": "Service"}]'
    name: "${NAME}-dev"
  spec:
    ports:
    - name: web
      port: 8081
      targetPort: 8081
    selector:
      name: "${NAME}"      
- apiVersion: v1
  kind: Route
  metadata:
    name: "${NAME}-dev"
  spec:
    host: "${APPLICATION_DOMAIN}"
    to:
      kind: Service
      name: "${NAME}-dev"
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    annotations:
      description: Defines how to deploy the application server
      template.alpha.openshift.io/wait-for-ready: 'true'
    name: "${NAME}"
  spec:
    replicas: 1
    selector:
      name: "${NAME}"
    strategy:
      recreateParams:
        pre:
          execNewPod:
            command:
            - "/usr/libexec/s2i/bin/migrate-database.sh"
            containerName: php
          failurePolicy: Retry
      type: Recreate
    template:
      metadata:
        labels:
          name: "${NAME}"
        name: "${NAME}"
      spec:
        containers:
        - env:
          - name: SESSION__SAVE_PATH
            value: /run/php/session
          - name: DATABASE_SERVICE_NAME
            value: "${DATABASE_SERVICE_NAME}"
          - name: DATABASE_ENGINE
            value: "${DATABASE_ENGINE}"
          - name: DATABASE_NAME
            value: "${DATABASE_NAME}"
          - name: DATABASE_USER
            valueFrom:
              secretKeyRef:
                key: database-user
                name: "${NAME}"
          - name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                key: database-password
                name: "${NAME}"
          - name: WP_SECRET_TOKEN
            valueFrom:
              secretKeyRef:
                key: wordpress-secret-token
                name: "${NAME}"
          - name: WP_SECURITY_SALT
            valueFrom:
              secretKeyRef:
                key: wordpress-security-salt
                name: "${NAME}"
          - name: OPCACHE_REVALIDATE_FREQ
            value: "${OPCACHE_REVALIDATE_FREQ}"
          image: "php"
          name: php
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 8090
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10        
          volumeMounts:
          - mountPath: "/tmp"
            name: "tmp"           
          - mountPath: "/var/run"
            name: "run"
          - mountPath: "/opt/app-root/etc/unit"
            name: "php-config"
          - mountPath: "/opt/app-root/src"
            name: "${NAME}-data"                    
          resources:
            limits:
              memory: "${MEMORY_LIMIT}"
        - env:
          - name: DOMAIN_PROD
            value: "${APPLICATION_DOMAIN}"
          image: "docker.io/oondeo/nginx"
          imagePullPolicy: Always 
          name: "nginx"      
          livenessProbe:
            initialDelaySeconds: 30
            tcpSocket:
              port: 8080
            timeoutSeconds: 2
          ports:
          - containerPort: 8080
          - containerPort: 8081
          volumeMounts:
          - mountPath: "/opt/app-root/etc/conf.d"
            name: "nginx-config"          
          - mountPath: "/opt/app-root/src"
            name: "${NAME}-data"
          - mountPath: "/var/run"
            name: "run" 
          - mountPath: "/tmp"
            name: "tmp"                        
        volumes:
        - name: "run"
          emptyDir: {}
        - name: "tmp"
          emptyDir:
            medium: Memory
        - name: "php-config"
          configMap:
            name: "${NAME}-php"
        - name: "nginx-config"
          configMap:
            name: "${NAME}-nginx"                     
        - name: "${NAME}-data"
          persistentVolumeClaim:
            claimName: "${NAME}"
    triggers:
    - imageChangeParams:
        automatic: true
        containerNames:
        - php
        from:
          kind: ImageStreamTag
          name: "php:7.2"
          namespace: "${NAMESPACE}"
      type: ImageChange
    - type: ConfigChange
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: "${DATABASE_SERVICE_NAME}"
  spec:
    accessModes:
    - ReadWriteOnce
    matchLabels:
      name: "${DATABASE_SERVICE_NAME}"
    storageClassName: local-storage
    resources:
      requests:
        storage: "${DB_VOLUME_CAPACITY}"
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: "${NAME}"
  spec:
    accessModes:
    - ReadWriteOnce
    storageClassName: local-storage
    matchLabels:
      name: "${NAME}"    
    resources:
      requests:
        storage: "${VOLUME_CAPACITY}"        
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      description: Exposes the database server
    name: "${DATABASE_SERVICE_NAME}"
  spec:
    ports:
    - name: mysql
      port: 3306
      targetPort: 3306
    selector:
      name: "${DATABASE_SERVICE_NAME}"
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    annotations:
      description: Defines how to deploy the database
      template.alpha.openshift.io/wait-for-ready: 'true'
    name: "${DATABASE_SERVICE_NAME}"
  spec:
    replicas: 1
    selector:
      name: "${DATABASE_SERVICE_NAME}"
    strategy:
      type: Recreate
    template:
      metadata:
        labels:
          name: "${DATABASE_SERVICE_NAME}"
        name: "${DATABASE_SERVICE_NAME}"
      spec:
        containers:
        - env:
          - name: MYSQLD__QUERY_CACHE_TYPE
            value: 'ON'          
          - name: MYSQLD__QUERY_CACHE_SIZE
            value: "50MB"
          - name: MYSQLD__JOIN_BUFFER_SIZE
            value: "1MB"
          - name: MYSQLD__SORT_BUFFER_SIZE
            value: "2MB"            
          - name: MYSQLD__TMP_TABLE_SIZE
            value: "50MB"
          - name: MYSQLD__MAX_HEAP_TABLE_SIZE
            value: "50MB"
          - name: MYSQLD__INNODB_DOUBLEWRITE
            value: "0"
          - name: MYSQLD__INNODB_LOG_FILE_SIZE
            value: "128M"
          - name: MYSQLD__INNODB_BUFFER_POOL_SIZE
            value: "1024M"
          - name: MYSQLD__INNODB_BUFFER_POOL_INSTANCES
            value: "2"            
          - name: MYSQL_USER
            valueFrom:
              secretKeyRef:
                key: database-user
                name: "${NAME}"
          - name: MYSQL_PASSWORD
            valueFrom:
              secretKeyRef:
                key: database-password
                name: "${NAME}"
          - name: MYSQL_DATABASE
            value: "${DATABASE_NAME}"
          image: " "
          livenessProbe:
            initialDelaySeconds: 30
            tcpSocket:
              port: 3306
            timeoutSeconds: 1
          name: mysql
          ports:
          - containerPort: 3306
          readinessProbe:
            exec:
              command:
              - "/bin/sh"
              - "-i"
              - "-c"
              - MYSQL_PWD="${MYSQL_PASSWORD}" mysql -h 127.0.0.1 -u ${MYSQL_USER} -D ${MYSQL_DATABASE} -e 'SELECT 1'
            initialDelaySeconds: 5
            timeoutSeconds: 1
          resources:
            limits:
              memory: "${MEMORY_MYSQL_LIMIT}"
          volumeMounts:
          - mountPath: "/opt/app-root/mysql"
            name: "${DATABASE_SERVICE_NAME}-data"
          - mountPath: "/tmp"
            name: "tmp"  
        volumes:
        - name: "${DATABASE_SERVICE_NAME}-data"
          persistentVolumeClaim:
            claimName: "${DATABASE_SERVICE_NAME}"
        - name: "tmp"
          emptyDir:
            medium: Memory           
    triggers:
    - imageChangeParams:
        automatic: true
        containerNames:
        - mysql
        from:
          kind: ImageStreamTag
          name: mariadb:10.3
          namespace: "${NAMESPACE}"
      type: ImageChange
    - type: ConfigChange
parameters:
- description: The name assigned to all of the frontend objects defined in this template.
  displayName: Name
  name: NAME
  required: true
  value: wordpress-mysql-persistent
- description: The OpenShift Namespace where the ImageStream resides.
  displayName: Namespace
  name: NAMESPACE
  required: true
  value: openshift
- description: Version of PHP image to be used (7.1 or latest).
  displayName: PHP Version
  name: PHP_VERSION
  required: true
  value: '7.2'
- description: Maximum amount of memory the WordPress container can use.
  displayName: Memory Limit
  name: MEMORY_LIMIT
  required: true
  value: 512Mi
- description: Maximum amount of memory the MySQL container can use.
  displayName: Memory Limit (MySQL)
  name: MEMORY_MYSQL_LIMIT
  required: true
  value: 512Mi
- description: Volume space available for data, e.g. 512Mi, 2Gi
  displayName: Volume Capacity
  name: VOLUME_CAPACITY
  required: true
  value: 2Gi
- description: Volume space available for db, e.g. 512Mi, 2Gi
  displayName: Volume Capacity
  name: DB_VOLUME_CAPACITY
  required: true
  value: 1Gi  
- description: The URL of the repository with your application source code.
  displayName: Git Repository URL
  name: SOURCE_REPOSITORY_URL
  required: true
  value: https://github.com/sclorg/wordpress-ex.git
- description: Set this to a branch name, tag or other ref of your repository if you
    are not using the default branch.
  displayName: Git Reference
  name: SOURCE_REPOSITORY_REF
- description: Set this to the relative path to your project if it is not in the root
    of your repository.
  displayName: Context Directory
  name: CONTEXT_DIR
- description: The exposed hostname that will route to the WordPress service, if left
    blank a value will be defaulted.
  displayName: Application Hostname
  name: APPLICATION_DOMAIN
  value: ''
- description: Github trigger secret.  A difficult to guess string encoded as part
    of the webhook URL.  Not encrypted.
  displayName: GitHub Webhook Secret
  from: "[a-zA-Z0-9]{40}"
  generate: expression
  name: GITHUB_WEBHOOK_SECRET
- displayName: Database Service Name
  name: DATABASE_SERVICE_NAME
  required: true
  value: mysql
- description: 'Database engine: postgresql, mysql or sqlite (default).'
  displayName: Database Engine
  name: DATABASE_ENGINE
  required: true
  value: mysql
- displayName: Database Name
  name: DATABASE_NAME
  required: true
  value: default
- displayName: Database User
  name: DATABASE_USER
  required: true
  value: wordpress
- displayName: Database Password
  from: "[a-zA-Z0-9]{16}"
  generate: expression
  name: DATABASE_PASSWORD
- description: Set this to a long random string.
  displayName: WordPress secret token
  from: "[\\w]{50}"
  generate: expression
  name: WP_SECRET_TOKEN
- description: Security salt for session hash.
  displayName: WordPress Security Salt
  from: "[a-zA-Z0-9]{40}"
  generate: expression
  name: WP_SECURITY_SALT
- description: How often to check script timestamps for updates, in seconds. 0 will
    result in OPcache checking for updates on every request.
  displayName: OPcache Revalidation Frequency
  name: OPCACHE_REVALIDATE_FREQ
  value: '2'
- description: The custom Composer mirror URL
  displayName: Custom Composer Mirror URL
  name: COMPOSER_MIRROR
  value: ''
